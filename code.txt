// ==UserScript==
// @name         升学E网通助手「修复版」
// @namespace    https://www.yuzu-soft.com/products.html
// @version      0.723-fix
// @description  自动通过随机检查、自动播放下一视频、自动跳过选择题，带开关控制
// @author       此项目是个人为了兴趣而开发, 仅用于学习和测试，请于下载后24小时内删除。
// @match        https://teacher.ewt360.com/*
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    /* ================== 首次使用弹窗 ================== */
    const disclaimerKey = 'ewt-helper-disclaimer-accepted';
    if (!localStorage.getItem(disclaimerKey)) {
        const msg = [
            '欢迎使用《升学E网通助手「修复版」》！',
            '',
            '⚠️ 免责声明：',
            '本脚本仅供学习与技术研究使用，禁止用于商业用途；',
            '使用本脚本造成的任何后果由使用者自行承担。',
            '',
            '🚫 特别提醒：',
            '此脚本为免费开源项目，禁止任何形式的倒卖行为！',
            '若您为付费获得，请立即退款并举报卖家！',
            '',
            '🙏 致敬原作者：',
            '脚本最初由 ZNink 开源发布，修复版在此向原作者致以崇高敬意！',
            '',
            '点击“确定”表示您已阅读并同意上述内容。'
        ].join('\n');

        if (confirm(msg)) {
            localStorage.setItem(disclaimerKey, 'true');
        } else {
            alert('您已取消使用，脚本将不会运行。');
            return;
        }
    }

    /* ================== 开关状态 ================== */
    let isCheckEnabled   = true;   // 自动过检
    let isRewatchEnabled = true;   // 自动连播
    let isSkipEnabled    = true;   // 自动跳过选择

    /* ================== 面板创建 ================== */
    const panel = document.createElement('div');
    panel.id = 'ewt-helper-panel';
    panel.style.position = 'fixed';
    panel.style.top = '10px';
    panel.style.left = '50%';
    panel.style.transform = 'translateX(-50%)';
    panel.style.zIndex = '9999';
    panel.style.backgroundColor = 'rgba(0,0,0,0.5)';
    panel.style.padding = '10px';
    panel.style.borderRadius = '25px';
    panel.style.color = '#fff';
    panel.style.fontSize = '14px';
    panel.style.display = 'flex';
    panel.style.alignItems = 'center';
    panel.style.gap = '10px';
    document.documentElement.appendChild(panel);

    /* ============ 通用：创建开关按钮 ============ */
    function createToggle(text, enabled, callback) {
        const btn = document.createElement('button');
        btn.textContent = `${text}: ${enabled ? '开' : '关'}`;
        btn.style.padding = '5px 10px';
        btn.style.border = 'none';
        btn.style.borderRadius = '15px';
        btn.style.cursor = 'pointer';
        btn.style.color = '#fff';
        btn.style.backgroundColor = enabled ? '#4CAF50' : '#f44336';
        btn.addEventListener('click', () => {
            const newState = !enabled;
            callback(newState);
            enabled = newState;
            btn.textContent = `${text}: ${enabled ? '开' : '关'}`;
            btn.style.backgroundColor = enabled ? '#4CAF50' : '#f44336';
        });
        return btn;
    }

    /* =============== 各功能实现 =============== */
    let checkId   = null;
    let watchId   = null;
    let skipId    = null;

    /* 1. 自动过检 */
    function toggleCheck(enable) {
        if (enable && !checkId) {
            checkId = setInterval(() => {
                const span = [...document.querySelectorAll('span')].find(el => el.textContent === '点击通过检查');
                if (span) span.click();
            }, 1000);
        } else if (!enable && checkId) {
            clearInterval(checkId);
            checkId = null;
        }
    }

    /* 2. 自动连播 */
    function toggleRewatch(enable) {
        if (enable && !watchId) {
            watchId = setInterval(() => {
                const rewatchBtn = document.querySelector('.progress-action-ghost-1cxSL');
                if (!rewatchBtn) return;

                const container = document.querySelector('.listCon-N9Rlm');
                if (!container) return;

                const active = container.querySelector('.item-IPNWw.active-1MWMf');
                if (!active) return;

                let next = active.nextElementSibling;
                while (next && !next.classList.contains('item-IPNWw')) next = next.nextElementSibling;
                if (next) next.click();
            }, 1000);
        } else if (!enable && watchId) {
            clearInterval(watchId);
            watchId = null;
        }
    }

    /* 3. 自动跳过选择 */
    function toggleSkip(enable) {
        if (enable && !skipId) {
            skipId = setInterval(() => {
                /* 优先点“跳过”按钮 */
                const skipBtn = [...document.querySelectorAll('button,span,a,div')]
                    .find(el => el.textContent.trim() === '跳过');
                if (skipBtn) {
                    skipBtn.click();
                    return;
                }

                /* 无“跳过”，则尝试自动答题 */
                const radio = document.querySelector('input[type="radio"]');
                if (radio) {
                    radio.click();
                    setTimeout(() => {
                        const nextBtn = [...document.querySelectorAll('button,span,a,div')]
                            .find(el => /下一题|提交|确定/i.test(el.textContent.trim()));
                        if (nextBtn) nextBtn.click();
                    }, 200);
                }
            }, 1000);
        } else if (!enable && skipId) {
            clearInterval(skipId);
            skipId = null;
        }
    }

    /* =============== 把按钮加到面板 =============== */
    panel.appendChild(createToggle('自动过检', isCheckEnabled, toggleCheck));
    panel.appendChild(createToggle('自动连播', isRewatchEnabled, toggleRewatch));
    panel.appendChild(createToggle('自动跳过选择', isSkipEnabled, toggleSkip));

    /* GitHub 链接 */
    const gh = document.createElement('a');
    gh.href = 'https://github.com/ZNink/EWT360-Helper';
    gh.target = '_blank';
    gh.textContent = 'GitHub';
    gh.style.color = '#fff';
    gh.style.backgroundColor = '#0366d6';
    gh.style.padding = '5px 10px';
    gh.style.borderRadius = '15px';
    gh.style.textDecoration = 'none';
    panel.appendChild(gh);

    /* =============== 初始启动 =============== */
    toggleCheck(isCheckEnabled);
    toggleRewatch(isRewatchEnabled);
    toggleSkip(isSkipEnabled);
})();
// Ciallo～(∠�9�9ω< )⌒★