// ==UserScript==
// @name         å‡å­¦Eç½‘é€šåŠ©æ‰‹ã€Œä¿®å¤ç‰ˆã€
// @namespace    https://www.yuzu-soft.com/products.html
// @version      0.723-fix
// @description  è‡ªåŠ¨é€šè¿‡éšæœºæ£€æŸ¥ã€è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€è§†é¢‘ã€è‡ªåŠ¨è·³è¿‡é€‰æ‹©é¢˜ï¼Œå¸¦å¼€å…³æ§åˆ¶
// @author       æ­¤é¡¹ç›®æ˜¯ä¸ªäººä¸ºäº†å…´è¶£è€Œå¼€å‘, ä»…ç”¨äºå­¦ä¹ å’Œæµ‹è¯•ï¼Œè¯·äºä¸‹è½½å24å°æ—¶å†…åˆ é™¤ã€‚
// @match        https://teacher.ewt360.com/*
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    /* ================== é¦–æ¬¡ä½¿ç”¨å¼¹çª— ================== */
    const disclaimerKey = 'ewt-helper-disclaimer-accepted';
    if (!localStorage.getItem(disclaimerKey)) {
        const msg = [
            'æ¬¢è¿ä½¿ç”¨ã€Šå‡å­¦Eç½‘é€šåŠ©æ‰‹ã€Œä¿®å¤ç‰ˆã€ã€‹ï¼',
            '',
            'âš ï¸ å…è´£å£°æ˜ï¼š',
            'æœ¬è„šæœ¬ä»…ä¾›å­¦ä¹ ä¸æŠ€æœ¯ç ”ç©¶ä½¿ç”¨ï¼Œç¦æ­¢ç”¨äºå•†ä¸šç”¨é€”ï¼›',
            'ä½¿ç”¨æœ¬è„šæœ¬é€ æˆçš„ä»»ä½•åæœç”±ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ‹…ã€‚',
            '',
            'ğŸš« ç‰¹åˆ«æé†’ï¼š',
            'æ­¤è„šæœ¬ä¸ºå…è´¹å¼€æºé¡¹ç›®ï¼Œç¦æ­¢ä»»ä½•å½¢å¼çš„å€’å–è¡Œä¸ºï¼',
            'è‹¥æ‚¨ä¸ºä»˜è´¹è·å¾—ï¼Œè¯·ç«‹å³é€€æ¬¾å¹¶ä¸¾æŠ¥å–å®¶ï¼',
            '',
            'ğŸ™ è‡´æ•¬åŸä½œè€…ï¼š',
            'è„šæœ¬æœ€åˆç”± ZNink å¼€æºå‘å¸ƒï¼Œä¿®å¤ç‰ˆåœ¨æ­¤å‘åŸä½œè€…è‡´ä»¥å´‡é«˜æ•¬æ„ï¼',
            '',
            'ç‚¹å‡»â€œç¡®å®šâ€è¡¨ç¤ºæ‚¨å·²é˜…è¯»å¹¶åŒæ„ä¸Šè¿°å†…å®¹ã€‚'
        ].join('\n');

        if (confirm(msg)) {
            localStorage.setItem(disclaimerKey, 'true');
        } else {
            alert('æ‚¨å·²å–æ¶ˆä½¿ç”¨ï¼Œè„šæœ¬å°†ä¸ä¼šè¿è¡Œã€‚');
            return;
        }
    }

    /* ================== å¼€å…³çŠ¶æ€ ================== */
    let isCheckEnabled   = true;   // è‡ªåŠ¨è¿‡æ£€
    let isRewatchEnabled = true;   // è‡ªåŠ¨è¿æ’­
    let isSkipEnabled    = true;   // è‡ªåŠ¨è·³è¿‡é€‰æ‹©

    /* ================== é¢æ¿åˆ›å»º ================== */
    const panel = document.createElement('div');
    panel.id = 'ewt-helper-panel';
    panel.style.position = 'fixed';
    panel.style.top = '10px';
    panel.style.left = '50%';
    panel.style.transform = 'translateX(-50%)';
    panel.style.zIndex = '9999';
    panel.style.backgroundColor = 'rgba(0,0,0,0.5)';
    panel.style.padding = '10px';
    panel.style.borderRadius = '25px';
    panel.style.color = '#fff';
    panel.style.fontSize = '14px';
    panel.style.display = 'flex';
    panel.style.alignItems = 'center';
    panel.style.gap = '10px';
    document.documentElement.appendChild(panel);

    /* ============ é€šç”¨ï¼šåˆ›å»ºå¼€å…³æŒ‰é’® ============ */
    function createToggle(text, enabled, callback) {
        const btn = document.createElement('button');
        btn.textContent = `${text}: ${enabled ? 'å¼€' : 'å…³'}`;
        btn.style.padding = '5px 10px';
        btn.style.border = 'none';
        btn.style.borderRadius = '15px';
        btn.style.cursor = 'pointer';
        btn.style.color = '#fff';
        btn.style.backgroundColor = enabled ? '#4CAF50' : '#f44336';
        btn.addEventListener('click', () => {
            const newState = !enabled;
            callback(newState);
            enabled = newState;
            btn.textContent = `${text}: ${enabled ? 'å¼€' : 'å…³'}`;
            btn.style.backgroundColor = enabled ? '#4CAF50' : '#f44336';
        });
        return btn;
    }

    /* =============== å„åŠŸèƒ½å®ç° =============== */
    let checkId   = null;
    let watchId   = null;
    let skipId    = null;

    /* 1. è‡ªåŠ¨è¿‡æ£€ */
    function toggleCheck(enable) {
        if (enable && !checkId) {
            checkId = setInterval(() => {
                const span = [...document.querySelectorAll('span')].find(el => el.textContent === 'ç‚¹å‡»é€šè¿‡æ£€æŸ¥');
                if (span) span.click();
            }, 1000);
        } else if (!enable && checkId) {
            clearInterval(checkId);
            checkId = null;
        }
    }

    /* 2. è‡ªåŠ¨è¿æ’­ */
    function toggleRewatch(enable) {
        if (enable && !watchId) {
            watchId = setInterval(() => {
                const rewatchBtn = document.querySelector('.progress-action-ghost-1cxSL');
                if (!rewatchBtn) return;

                const container = document.querySelector('.listCon-N9Rlm');
                if (!container) return;

                const active = container.querySelector('.item-IPNWw.active-1MWMf');
                if (!active) return;

                let next = active.nextElementSibling;
                while (next && !next.classList.contains('item-IPNWw')) next = next.nextElementSibling;
                if (next) next.click();
            }, 1000);
        } else if (!enable && watchId) {
            clearInterval(watchId);
            watchId = null;
        }
    }

    /* 3. è‡ªåŠ¨è·³è¿‡é€‰æ‹© */
    function toggleSkip(enable) {
        if (enable && !skipId) {
            skipId = setInterval(() => {
                /* ä¼˜å…ˆç‚¹â€œè·³è¿‡â€æŒ‰é’® */
                const skipBtn = [...document.querySelectorAll('button,span,a,div')]
                    .find(el => el.textContent.trim() === 'è·³è¿‡');
                if (skipBtn) {
                    skipBtn.click();
                    return;
                }

                /* æ— â€œè·³è¿‡â€ï¼Œåˆ™å°è¯•è‡ªåŠ¨ç­”é¢˜ */
                const radio = document.querySelector('input[type="radio"]');
                if (radio) {
                    radio.click();
                    setTimeout(() => {
                        const nextBtn = [...document.querySelectorAll('button,span,a,div')]
                            .find(el => /ä¸‹ä¸€é¢˜|æäº¤|ç¡®å®š/i.test(el.textContent.trim()));
                        if (nextBtn) nextBtn.click();
                    }, 200);
                }
            }, 1000);
        } else if (!enable && skipId) {
            clearInterval(skipId);
            skipId = null;
        }
    }

    /* =============== æŠŠæŒ‰é’®åŠ åˆ°é¢æ¿ =============== */
    panel.appendChild(createToggle('è‡ªåŠ¨è¿‡æ£€', isCheckEnabled, toggleCheck));
    panel.appendChild(createToggle('è‡ªåŠ¨è¿æ’­', isRewatchEnabled, toggleRewatch));
    panel.appendChild(createToggle('è‡ªåŠ¨è·³è¿‡é€‰æ‹©', isSkipEnabled, toggleSkip));

    /* GitHub é“¾æ¥ */
    const gh = document.createElement('a');
    gh.href = 'https://github.com/ZNink/EWT360-Helper';
    gh.target = '_blank';
    gh.textContent = 'GitHub';
    gh.style.color = '#fff';
    gh.style.backgroundColor = '#0366d6';
    gh.style.padding = '5px 10px';
    gh.style.borderRadius = '15px';
    gh.style.textDecoration = 'none';
    panel.appendChild(gh);

    /* =============== åˆå§‹å¯åŠ¨ =============== */
    toggleCheck(isCheckEnabled);
    toggleRewatch(isRewatchEnabled);
    toggleSkip(isSkipEnabled);
})();
// Cialloï½(âˆ ï¿½9ï¿½9Ï‰< )âŒ’â˜…